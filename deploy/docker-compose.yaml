services:
  app:
    # image: ghcr.io/xlansoftware/chat:latest
    build:
      context: ../src/chat
      dockerfile: Dockerfile
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    environment:
      MCP_SERVER_ENDPOINT: http://mcp-server:8787/mcp
      STORAGE_TYPE: filesystem
      DATA_STORE_PATH: /data
      CONFIG_PATH: /config
      OPENAI_API_KEY: ${OPENAI_API_KEY:?OPENAI_API_KEY is required}
      PORT: ${PORT:-3000}
      NODE_ENV: production
      LOG_LEVEL: info
    volumes:
      - ./models.yaml:/config/models.yaml:ro
      - ../notes:/data
    restart: unless-stopped

  mcp-server:
    # image: ghcr.io/xlansoftware/chat-mcp-http-gateway:latest
    build:
      context: ../src/mcp-http-gateway
      dockerfile: Dockerfile
    read_only: true
    tmpfs:
      - /tmp
    environment:
      NODE_ENV: production
      NPM_CONFIG_UPDATE_NOTIFIER: false
      NPM_CONFIG_CACHE: /npm-cache
      NPM_CONFIG_PREFER_OFFLINE: "true"
      NPM_CONFIG_AUDIT: "false"
      NPM_CONFIG_FUND: "false"
      MCP_SERVERS_CONFIG: /config/mcpServers.json
      MCP_SERVER_NAME: filesystem
    volumes:
      - npm-cache:/npm-cache
      - ./mcpServers.json:/config/mcpServers.json:ro
      - ../notes/projects:/projects
    restart: unless-stopped
    depends_on:
      npm-cache-permissions:
        condition: service_completed_successfully

  npm-cache-permissions:
    image: alpine:latest
    command: chown -R 65532:65532 /npm-cache
    volumes:
      - npm-cache:/npm-cache
    user: root

volumes:
  npm-cache:
